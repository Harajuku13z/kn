@extends('layouts.dashboard')

@section('title', 'Nouvelle Commande Pressing - KLINKLIN')

@push('styles')
<style>
    :root {
        --klin-primary: #4A148C; /* Violet */
        --klin-primary-dark: #38006b;
        --klin-secondary: #f26d50; /* Orange/Corail */
        --klin-light-bg: #f8f5fc; /* Violet très clair */
        --klin-border-color: #e0d8e7; /* Bordure violette claire */
        --klin-text-muted: #6c757d;
        --klin-success: #198754; /* Vert Bootstrap pour succès */
        --klin-warning: #ffc107;
        --klin-danger: #dc3545;
        --klin-info: #0dcaf0;
        --klin-input-bg: #fff;
    }

    /* Styles Généraux de la Page */
    .order-creation-pressing-page .display-5 {
        font-size: 2rem; /* Ajustement taille titre principal */
        color: var(--klin-primary);
    }
    .order-creation-pressing-page .text-klin-primary { color: var(--klin-primary) !important; }

    .klin-btn {
        background-color: var(--klin-primary) !important;
        border-color: var(--klin-primary) !important;
        color: white !important;
        transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        border-radius: 50px;
        padding: 0.6rem 1.5rem;
        font-weight: 500;
        box-shadow: 0 2px 5px rgba(74,20,140,.2);
    }
    .klin-btn:hover {
        background-color: var(--klin-primary-dark) !important;
        border-color: var(--klin-primary-dark) !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(74,20,140,.3);
    }
    .klin-btn-outline {
        color: var(--klin-primary) !important;
        border-color: var(--klin-primary) !important;
        border-radius: 50px;
        padding: 0.6rem 1.5rem;
        font-weight: 500;
        transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .klin-btn-outline:hover {
        background-color: var(--klin-primary) !important;
        color: white !important;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(74,20,140,.2);
    }

    /* Champs de Formulaire */
    .form-label { font-weight: 500; color: #333; margin-bottom: 0.3rem; font-size: 0.9rem;}
    .form-control, .form-select {
        border-radius: 0.5rem; /* Arrondi plus prononcé */
        border: 1px solid var(--klin-border-color);
        background-color: var(--klin-input-bg);
        padding: 0.75rem 1rem; /* Padding interne augmenté */
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .form-control:focus, .form-select:focus {
        border-color: var(--klin-primary);
        box-shadow: 0 0 0 0.25rem rgba(74, 20, 140, 0.25);
    }
    .form-floating > .form-control:focus ~ label,
    .form-floating > .form-control:not(:placeholder-shown) ~ label,
    .form-floating > .form-select ~ label {
        color: var(--klin-primary);
    }


    /* Barre de Progression */
    .progress-bar-custom {
        margin-bottom: 2.5rem !important;
        padding: 1rem 0;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.07);
    }
    .progress-bar-custom .step-custom {
        flex-basis: auto; /* Ajustement pour flexibilité */
        padding: 0 0.5rem;
        color: var(--klin-text-muted);
        font-size: 0.8rem;
        position: relative;
    }
    .progress-bar-custom .step-icon {
        width: 30px; height: 30px;
        border-radius: 50%;
        background-color: var(--klin-border-color); /* Fond gris clair */
        color: var(--klin-text-muted); /* Texte gris pour les chiffres non actifs */
        display: flex; justify-content: center; align-items: center;
        margin: 0 auto 6px auto;
        border: none; /* Pas de double bordure */
        font-weight: 700;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .progress-bar-custom .step-icon span { font-size: 0.85rem; }
    .progress-bar-custom .step-custom.active .step-icon {
        background-color: var(--klin-primary);
        color: white;
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(74,20,140,.3);
    }
    .progress-bar-custom .step-custom.active .step-text { color: var(--klin-primary); font-weight: 700; }
    .progress-bar-custom .step-custom.completed .step-icon {
        background-color: var(--klin-success);
        border-color: var(--klin-success);
        color: white;
    }
    .progress-bar-custom .step-custom.completed .step-text { color: var(--klin-success); }
    .progress-bar-custom .progress-line-custom {
        height: 3px;
        background-color: var(--klin-border-color);
        margin-top: 15px; /* Aligner avec le centre des icônes */
        transition: background-color 0.3s ease;
        flex-grow: 1; /* S'assurer qu'elle remplit l'espace */
    }
    .progress-bar-custom .progress-line-custom.active { background-color: var(--klin-primary); }


    /* Conteneur principal du formulaire */
    .order-creation-pressing-page .card.shadow-sm {
        border-radius: 0.75rem;
        border: 1px solid var(--klin-border-color);
        box-shadow: 0 0.25rem 1rem rgba(74,20,140,.07)!important;
    }
    .order-creation-pressing-page .card.shadow-sm > .card-body {
        padding: 1.5rem 2rem; /* Plus de padding */
    }


    /* Style des étapes du formulaire */
    .form-step { display: none; }
    .form-step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .form-step h3 { /* Titres de chaque étape */
        font-weight: 600;
        color: var(--klin-primary);
        margin-bottom: 2rem !important; /* Plus d'espace */
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--klin-light-bg);
    }
    .form-step h3 .bi {
        margin-right: 0.5rem;
        font-size: 1.2em; /* Icônes de titre plus grandes */
    }


    /* Cartes de Sélection de Pressing (Étape 0) */
    .pressing-card {
        border: 1px solid var(--klin-border-color);
        border-radius: 15px;
        transition: all 0.3s ease-in-out;
        cursor: pointer;
        margin-bottom: 20px;
        overflow: hidden;
        background-color: #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        position: relative;
    }
    .pressing-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 20px rgba(74,20,140,0.15);
        border-color: var(--klin-primary);
    }
    .pressing-card.selected {
        border: 2px solid var(--klin-primary);
        box-shadow: 0 8px 25px rgba(74, 20, 140, 0.25);
        background-color: var(--klin-light-bg);
    }
    .pressing-card::after {
        content: '';
        position: absolute;
        top: 12px;
        right: 12px;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background-color: var(--klin-light-bg);
        border: 1px solid var(--klin-border-color);
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .pressing-card.selected::after {
        content: '✓';
        opacity: 1;
        background-color: var(--klin-primary);
        color: white;
        border-color: var(--klin-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    .pressing-card .card-img-container {
        height: 120px;
        background: linear-gradient(45deg, var(--klin-light-bg), #f0f0f0);
        position: relative;
        overflow: hidden;
    }
    .pressing-card .card-img-top {
        height: 100%;
        width: 100%;
        object-fit: cover;
    }
    .pressing-card .default-banner-svg {
        height: 100%;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f7fa;
    }
    .pressing-card .default-banner-svg svg {
        height: 100%;
        width: 100%;
    }
    .pressing-card .card-logo-wrapper {
        position: absolute;
        bottom: -25px;
        left: 15px;
        background: white;
        border-radius: 50%;
        padding: 3px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        z-index: 1;
        border: 2px solid white;
    }
    .pressing-card .card-logo {
        width: 60px;
        height: 60px;
        object-fit: contain;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .pressing-card .card-body {
        padding-top: 35px;
        padding-left: 15px;
        padding-right: 15px;
        padding-bottom: 15px;
    }
    .pressing-card .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--klin-primary);
        margin-bottom: 0.25rem;
    }
    .pressing-card.selected .card-title {
        color: var(--klin-primary-dark);
    }
    .pressing-card .card-text i {
        color: var(--klin-primary);
    }
    .pressing-features {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 8px;
    }
    .pressing-feature {
        font-size: 0.75rem;
        background: var(--klin-border-color);
        padding: 3px 10px;
        border-radius: 20px;
        color: var(--klin-text-muted);
        transition: all 0.3s ease;
    }
    .pressing-card:hover .pressing-feature {
        background-color: rgba(74,20,140,0.1);
    }
    .pressing-card.selected .pressing-feature {
        background-color: var(--klin-primary);
        color: white;
    }
    .pressing-select-btn {
        opacity: 0;
        transition: opacity 0.3s ease;
        margin-top: 10px;
    }
    .pressing-card:hover .pressing-select-btn,
    .pressing-card.selected .pressing-select-btn {
        opacity: 1;
    }
    .pressing-card .select-pressing {
        font-size: 0.85rem;
        padding: 0.4rem 1rem;
        transition: all 0.3s ease;
    }

    /* Étapes 1 & 2 : Adresses et Dates */
    #selected_pressing_display {
        font-weight: 500; color: var(--klin-primary); padding: 0.75rem 1rem;
    }

    /* Étape 3 : Sélection des services */
    .category-tab {
        padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 0.5rem;
        cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent;
    }
    .category-tab:hover { background-color: var(--klin-light-bg); border-color: var(--klin-border-color); }
    .category-tab.active {
        background-color: var(--klin-primary) !important; color: white !important;
        font-weight: 600; box-shadow: 0 2px 5px rgba(74,20,140,.2);
    }
    .category-tab.active .icon { color: white !important; }
    .category-tab .icon { font-size: 1.2rem; color: var(--klin-primary); margin-right: 0.75rem; }

    #servicesContainer .service-item .card {
        border: 1px solid var(--klin-border-color); border-radius: 0.5rem;
        transition: all 0.2s ease; background-color: #fff; margin-bottom: 1rem;
    }
    #servicesContainer .service-item .card:hover {
        transform: translateY(-2px); box-shadow: 0 0.25rem 1rem rgba(74,20,140,.1);
        border-color: var(--klin-primary);
    }
    #servicesContainer .card-title { font-size: 0.95rem; font-weight: 600; color: var(--klin-primary); margin-bottom: 0.25rem;}
    #servicesContainer .card-text small { font-size: 0.8rem; }
    #servicesContainer .badge.bg-primary { background-color: var(--klin-primary) !important; }
    #servicesContainer .quantity-selector input {
        border-left: none; border-right: none; border-radius:0;
        max-width: 50px; font-weight:500;
    }
    #servicesContainer .quantity-selector .btn {
        border-color: var(--klin-border-color); background-color: #fff; color: var(--klin-primary);
    }
    #servicesContainer .quantity-selector .btn:hover { background-color: var(--klin-light-bg); }
    #servicesContainer .sticky-top { z-index: 100; } /* Pour que le total reste visible */
    #servicesContainer .sticky-top .card { border: 1px solid var(--klin-primary); }

    /* Étape 4 : Récapitulatif */
    #step-4 .card {
        border: 1px solid var(--klin-border-color);
        border-radius: 0.5rem;
        margin-bottom: 1rem !important;
        background-color: #fff;
    }
    #step-4 .card-header {
        background-color: var(--klin-light-bg);
        border-bottom: 1px solid var(--klin-border-color);
        padding: 0.75rem 1.25rem;
    }
    #step-4 .card-header h5 { font-weight: 600; color: var(--klin-primary); font-size: 1rem; }
    #step-4 #summary-items td, #step-4 #summary-items th { padding: 0.6rem; font-size:0.85rem; }
    #step-4 #summary-total { font-size: 1.1rem; color: var(--klin-primary); font-weight: 700; }
    #step-4 .table-striped tbody tr:nth-of-type(odd) { background-color: rgba(74,20,140,.03); }


    /* Étape 5 : Paiement */
    #step-5 .form-check-label {
        display: flex; flex-direction: column; align-items: flex-start;
        font-size: 0.95rem; padding: 1rem; border: 1px solid var(--klin-border-color);
        border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease;
        background-color: #fff;
    }
    #step-5 .form-check-label:hover { background-color: var(--klin-light-bg); }
    #step-5 .form-check-input:checked + .form-check-label {
        background-color: var(--klin-light-bg);
        border-color: var(--klin-primary);
        color: var(--klin-primary);
        box-shadow: 0 0 10px rgba(74,20,140,.1);
    }
    #step-5 .form-check-input { display: none; } /* Cache le radio bouton natif */
    #step-5 .form-check-label .bi {
        font-size: 1.3rem; color: var(--klin-primary); margin-right: 0.5rem;
        margin-bottom: 0.25rem;
    }
     #step-5 .form-check-label strong { font-size: 1.05rem; }

    /* Alertes */
    .alert { border-radius: 0.5rem; padding: 1rem; }
    .alert-danger { background-color: #f8d7da; border-color: #f5c2c7; color: #721c24; }
    .alert-danger .alert-heading { color: inherit; }
    .alert-info { background-color: #cff4fc; border-color: #b6effb; color: #055160; }

    /* Style pour l'étape 5 amélioré */
    .hover-card {
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    input[type="radio"]:checked + label .hover-card {
        border-color: var(--klin-primary);
        background-color: var(--klin-light-bg);
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(74,20,140,0.15) !important;
    }
    
    label.form-check-label {
        cursor: pointer;
    }
    
    input[type="radio"]:disabled + label {
        cursor: not-allowed;
    }
    
    #step-5 .form-check-input {
        position: absolute;
        opacity: 0;
    }
    
    .hover-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(74,20,140,0.1) !important;
    }
    
</style>
@endpush

@section('content')
<div class="container-fluid order-creation-pressing-page py-4">
    <div class="row mb-4 align-items-center">
        <div class="col-auto">
             <div style="background-color: var(--klin-light-bg); border-radius: 50%; padding: 0.6rem; display: flex; align-items: center; justify-content: center; width: 50px; height: 50px; box-shadow: 0 3px 10px rgba(74,20,140,.1);">
                <i class="bi bi-scissors fs-3 text-klin-primary"></i>
            </div>
        </div>
        <div class="col">
            <h1 class="display-5 fw-bold text-klin-primary">Nouvelle Commande Pressing</h1>
            <p class="text-muted fs-6 mb-0">Suivez les étapes pour créer votre commande de service pressing.</p>
        </div>
    </div>

    <!-- Ajout du token CSRF pour les requêtes AJAX -->
    <meta name="csrf-token" content="{{ csrf_token() }}">

    @if(session('error'))
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-octagon-fill me-2"></i>
            <strong>Erreur :</strong> {!! nl2br(e(session('error'))) !!}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    @endif

    @if($errors->any())
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill fs-3 me-3"></i>
                <div>
                    <h5 class="alert-heading fw-bold mb-1">Erreurs de validation</h5>
                    <ul class="mb-0 ps-3" style="font-size: 0.9rem;">
                        @foreach($errors->all() as $error)
                            <li>{{ $error }}</li>
                        @endforeach
                    </ul>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="top: 50%; transform: translateY(-50%);"></button>
        </div>
    @endif

    <div class="row">
        <div class="col-12">
            <div class="progress-bar-custom d-flex justify-content-around align-items-center">
                <div class="step-custom text-center active" data-step="0">
                    <div class="step-icon"><span><i class="bi bi-shop"></i></span></div>
                    <div class="step-text">Pressing</div>
                </div>
                <div class="progress-line-custom"></div>
                <div class="step-custom text-center" data-step="1">
                    <div class="step-icon"><span><i class="bi bi-geo-alt-fill"></i></span></div>
                    <div class="step-text">Collecte</div>
                </div>
                <div class="progress-line-custom"></div>
                <div class="step-custom text-center" data-step="2">
                    <div class="step-icon"><span><i class="bi bi-truck"></i></span></div>
                    <div class="step-text">Livraison</div>
                </div>
                <div class="progress-line-custom"></div>
                <div class="step-custom text-center" data-step="3">
                    <div class="step-icon"><span><i class="bi bi-card-checklist"></i></span></div>
                    <div class="step-text">Services</div>
                </div>
                <div class="progress-line-custom"></div>
                <div class="step-custom text-center" data-step="4">
                    <div class="step-icon"><span><i class="bi bi-receipt"></i></span></div>
                    <div class="step-text">Récap.</div>
                </div>
                <div class="progress-line-custom"></div>
                <div class="step-custom text-center" data-step="5">
                     <div class="step-icon"><span><i class="bi bi-credit-card-fill"></i></span></div>
                    <div class="step-text">Paiement</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mt-2">
        <div class="card-body p-lg-4 p-3">
            <form id="orderForm" action="{{ route('orders.store') }}" method="POST">
                @csrf
                <input type="hidden" name="form_submitted" value="true">
                <input type="hidden" name="order_type" value="pressing">
                <input type="hidden" name="pressing_id" id="selected_pressing_id_field" value="{{ $pressingId ?? request()->route('id') ?? old('pressing_id') }}">

                <div class="form-step active" id="step-0">
                    <h3 class="text-klin-primary"><i class="bi bi-shop"></i> Choisissez votre pressing préféré</h3>
                    <p class="text-muted mb-4">Sélectionnez le pressing qui prendra en charge votre commande.</p>
                    <div class="row g-3">
                        @forelse($pressings as $pressing)
                        <div class="col-md-6 col-lg-4 d-flex">
                            <div class="pressing-card card w-100 {{ (isset($pressingId) && $pressingId == $pressing->id) || old('pressing_id') == $pressing->id ? 'selected' : '' }}" data-pressing-id="{{ $pressing->id }}">
                                <div class="card-img-container">
                                    @if($pressing->banner_image_url)
                                        <img src="{{ $pressing->banner_image_url }}" class="card-img-top" alt="{{ $pressing->name }}" onerror="this.src='{{ asset('images/pressing-banner-default.jpg') }}'; this.onerror='';">
                                    @else
                                        <div class="default-banner-svg">
                                            <svg width="100%" height="100%" viewBox="0 0 800 300" xmlns="http://www.w3.org/2000/svg">
                                                <defs>
                                                    <linearGradient id="grad-{{ $pressing->id }}" x1="0%" y1="0%" x2="100%" y2="100%">
                                                        <stop offset="0%" stop-color="#f8f5fc" />
                                                        <stop offset="100%" stop-color="#e0d8e7" />
                                                    </linearGradient>
                                                    <pattern id="pattern-{{ $pressing->id }}" width="40" height="40" patternUnits="userSpaceOnUse" patternTransform="rotate(45)">
                                                        <rect width="100%" height="100%" fill="url(#grad-{{ $pressing->id }})" />
                                                        <circle cx="20" cy="20" r="3" fill="#4A148C" fill-opacity="0.1" />
                                                    </pattern>
                                                </defs>
                                                <rect width="100%" height="100%" fill="url(#pattern-{{ $pressing->id }})" />
                                                <g transform="translate(20, 70)">
                                                    <path d="M10,10 L40,10 L40,60 C40,70 30,80 20,80 L10,80 Z" fill="#4A148C" fill-opacity="0.15" />
                                                    <path d="M60,10 L120,10 C130,10 140,20 140,30 L140,60 C140,70 130,80 120,80 L60,80 Z" fill="#4A148C" fill-opacity="0.2" />
                                                </g>
                                                <g transform="translate(600, 40)">
                                                    <circle cx="30" cy="30" r="25" fill="#4A148C" fill-opacity="0.15" />
                                                    <circle cx="80" cy="30" r="15" fill="#4A148C" fill-opacity="0.2" />
                                                </g>
                                                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial, sans-serif" font-size="24" fill="#4A148C" fill-opacity="0.3">KLINKLIN Pressing</text>
                                            </svg>
                                        </div>
                                    @endif
                                    <div class="card-logo-wrapper">
                                        @if($pressing->logo_url)
                                            <img src="{{ $pressing->logo_url }}" class="card-logo" alt="Logo {{ $pressing->name }}" onerror="this.onerror=''; this.parentElement.innerHTML = '<div class=\'card-logo\'><i class=\'bi bi-shop fs-3 text-klin-primary\'></i></div>';">
                                        @else
                                            <div class="card-logo">
                                                <i class="bi bi-shop fs-3 text-klin-primary"></i>
                                            </div>
                                        @endif
                                    </div>
                                </div>
                                <div class="card-body">
                                    <h5 class="card-title">{{ $pressing->name }}</h5>
                                    <p class="card-text small text-muted mb-2"><i class="bi bi-geo-alt-fill me-1"></i>{{ $pressing->address }}</p>
                                    <div class="pressing-features mb-3">
                                        @if($pressing->is_express)
                                            <span class="pressing-feature"><i class="bi bi-lightning-fill me-1"></i> Express</span>
                                        @endif
                                        @if($pressing->eco_friendly)
                                            <span class="pressing-feature"><i class="bi bi-flower1 me-1"></i> Éco-responsable</span>
                                        @endif
                                        @if($pressing->has_delivery)
                                            <span class="pressing-feature"><i class="bi bi-truck me-1"></i> Livraison</span>
                                        @endif
                                    </div>
                                    <div class="text-start pressing-select-btn">
                                        <a href="{{ route('orders.create.pressing.show', $pressing->id) }}" class="btn btn-sm klin-btn select-pressing-btn" data-pressing-id="{{ $pressing->id }}">
                                            <i class="bi bi-check-circle-fill me-1"></i> Sélectionner
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        @empty
                        <div class="col-12">
                            <div class="alert alert-warning text-center">Aucun pressing disponible pour le moment.</div>
                        </div>
                        @endforelse
                    </div>
                     @error('pressing_id') <div class="invalid-feedback d-block">{{ $message }}</div> @enderror
                </div>

                <div class="form-step" id="step-1">
                    <h3 class="text-klin-primary"><i class="bi bi-geo-alt-fill"></i> Adresse et date de collecte</h3>
                    <div class="mb-3 form-floating">
                        <input type="text" class="form-control bg-light" id="selected_pressing_display" readonly value="{{ (isset($pressingId) && $pressings->where('id', $pressingId)->first()) ? $pressings->where('id', $pressingId)->first()->name . ' - ' . $pressings->where('id', $pressingId)->first()->address : 'Veuillez sélectionner un pressing à l\'étape précédente' }}">
                        <label for="selected_pressing_display">Pressing sélectionné</label>
                    </div>

                    <div class="mb-4">
                        <label for="collection_address_id" class="form-label">Adresse de collecte <span class="text-danger">*</span></label>
                        <select class="form-select" name="collection_address_id" id="collection_address_id" required>
                            <option value="">Sélectionnez une adresse</option>
                            @foreach($addresses as $address)
                                <option value="{{ $address->id }}" {{ old('collection_address_id', $tempCart['collection_address_id'] ?? '') == $address->id ? 'selected' : '' }}>
                                    {{ $address->name }} - {{ $address->address }}, {{ $address->neighborhood }}
                                </option>
                            @endforeach
                        </select>
                        <div class="form-text mt-1" id="collection-address-fee-info" style="display: none;"></div>
                        <div class="form-text mt-2">
                            <a href="{{ route('addresses.create') }}" target="_blank" class="btn btn-sm btn-outline-klin me-2"><i class="bi bi-plus-circle"></i> Ajouter une nouvelle adresse</a>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="date" class="form-control @error('collection_date') is-invalid @enderror" id="collection_date" name="collection_date" value="{{ old('collection_date', $tempCart['collection_date'] ?? now()->format('Y-m-d')) }}" min="{{ now()->format('Y-m-d') }}" required placeholder="Date">
                                <label for="collection_date">Date de collecte <span class="text-danger">*</span></label>
                                @error('collection_date') <div class="invalid-feedback">{{ $message }}</div> @enderror
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select @error('collection_time_slot') is-invalid @enderror" id="collection_time_slot" name="collection_time_slot" required aria-label="Créneau horaire">
                                    <option value="">Sélectionner un créneau...</option>
                                    @foreach($timeSlots as $value => $label)
                                        <option value="{{ $value }}" @if(old('collection_time_slot', $tempCart['collection_time_slot'] ?? '') == $value) selected @endif>{{ $label }}</option>
                                    @endforeach
                                </select>
                                <label for="collection_time_slot">Créneau horaire <span class="text-danger">*</span></label>
                                @error('collection_time_slot') <div class="invalid-feedback">{{ $message }}</div> @enderror
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-step" id="step-2">
                    <h3 class="text-klin-primary"><i class="bi bi-truck"></i> Adresse et date de livraison</h3>
                    <div class="form-check mb-3 ps-0">
                        <input class="form-check-input ms-1 me-2" type="checkbox" id="same_address_for_delivery_step2" name="same_address_for_delivery" @if(old('same_address_for_delivery', $tempCart['same_address_for_delivery'] ?? false)) checked @endif style="width:1.2em; height:1.2em;">
                        <label class="form-check-label" for="same_address_for_delivery_step2" style="font-weight:500;">
                            Utiliser la même adresse que pour la collecte
                        </label>
                    </div>

                    <div id="delivery-address-fields" class="form-floating mb-3" @if(old('same_address_for_delivery', $tempCart['same_address_for_delivery'] ?? false)) style="display: none;" @endif>
                        <select class="form-select @error('delivery_address_id') is-invalid @enderror" id="delivery_address_id" name="delivery_address_id" @if(!old('same_address_for_delivery', $tempCart['same_address_for_delivery'] ?? false)) required @endif aria-label="Adresse de livraison">
                            <option value="">Sélectionner une adresse...</option>
                            @foreach($addresses as $address)
                                <option value="{{ $address->id }}" @if(old('delivery_address_id', $tempCart['delivery_address_id'] ?? '') == $address->id) selected @endif data-full-address="{{ $address->name }} - {{ $address->address }}, {{ $address->neighborhood }}">
                                    {{ $address->name }} - {{ $address->address }}, {{ $address->neighborhood }}
                                </option>
                            @endforeach
                        </select>
                        <label for="delivery_address_id">Adresse de livraison <span class="text-danger">*</span></label>
                        @error('delivery_address_id') <div class="invalid-feedback">{{ $message }}</div> @enderror
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                           <div class="form-floating">
                                <input type="date" class="form-control @error('delivery_date') is-invalid @enderror" id="delivery_date" name="delivery_date" value="{{ old('delivery_date', $tempCart['delivery_date'] ?? '') }}" required placeholder="Date">
                                <label for="delivery_date">Date de livraison <span class="text-danger">*</span></label>
                                <small class="text-muted ps-1">Date minimum : le lendemain de la collecte.</small>
                                @error('delivery_date') <div class="invalid-feedback">{{ $message }}</div> @enderror
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-floating">
                                <select class="form-select @error('delivery_time_slot') is-invalid @enderror" id="delivery_time_slot" name="delivery_time_slot" required aria-label="Créneau horaire">
                                    <option value="">Sélectionner un créneau...</option>
                                    @foreach($timeSlots as $value => $label)
                                        <option value="{{ $value }}" @if(old('delivery_time_slot', $tempCart['delivery_time_slot'] ?? '') == $value) selected @endif>{{ $label }}</option>
                                    @endforeach
                                </select>
                                <label for="delivery_time_slot">Créneau horaire <span class="text-danger">*</span></label>
                                @error('delivery_time_slot') <div class="invalid-feedback">{{ $message }}</div> @enderror
                            </div>
                        </div>
                    </div>

                    <div class="form-floating mt-3">
                        <textarea class="form-control @error('delivery_notes') is-invalid @enderror" id="delivery_notes" name="delivery_notes" rows="3" placeholder="Instructions de livraison" style="height: 100px">{{ old('delivery_notes', $tempCart['delivery_notes'] ?? '') }}</textarea>
                        <label for="delivery_notes">Instructions de livraison <small class="text-muted">(facultatif)</small></label>
                        @error('delivery_notes') <div class="invalid-feedback">{{ $message }}</div> @enderror
                    </div>
                </div>

                <div class="form-step" id="step-3">
                    <h3 class="mb-2"><i class="bi bi-card-checklist"></i> Sélection des services de pressing</h3>
                    <p class="text-muted mb-4">Sélectionnez les vêtements et services pour votre commande pressing.</p>

                    <div class="row g-4">
                        <div class="col-md-3">
                            <div class="sticky-top" style="top: 20px;">
                                <div class="card mb-4 shadow-sm">
                                    <div class="card-header bg-white">
                                        <strong>Catégories</strong>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="list-group list-group-flush" id="categories-list">
                                            <a href="#" class="list-group-item list-group-item-action category-tab active" data-category="all">
                                                <i class="bi bi-grid-fill icon"></i> Tous les services
                                            </a>
                                            <!-- Les catégories seront remplies via JavaScript -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title">Montant estimé</h5>
                                        <div class="d-flex align-items-baseline mt-3">
                                            <span class="fs-4 fw-bold text-klin-primary" id="estimatedPriceDisplay">0</span>
                                            <span class="ms-1">FCFA</span>
                                        </div>
                                        <small class="text-muted">Frais de livraison inclus</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="row" id="servicesContainer">
                                <!-- Les services seront remplis via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-step" id="step-4">
                    <h3 class="text-klin-primary"><i class="bi bi-receipt"></i> Récapitulatif de votre commande</h3>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>Commande & Pressing</h5></div>
                                <div class="card-body">
                                    <p class="mb-1"><strong>Type :</strong> <span class="badge rounded-pill" style="background-color: var(--klin-secondary); color:white; font-size: 0.9rem;">Commande Pressing</span></p>
                                    <p class="mb-0"><strong>Pressing :</strong> <span id="summary-pressing-name" class="fw-500">Chargement...</span></p>
                                </div>
                            </div>
                        </div>
                         <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="bi bi-calendar3-week me-2"></i>Planification</h5></div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-sm-6 mb-2 mb-sm-0">
                                            <p class="mb-1"><strong>Collecte :</strong></p>
                                            <div id="summary-collection-date" class="small">Date à définir</div>
                                            <div id="summary-collection-time" class="small fw-500">Créneau à définir</div>
                                        </div>
                                        <div class="col-sm-6">
                                            <p class="mb-1"><strong>Livraison :</strong></p>
                                            <div id="summary-delivery-date" class="small">Date à définir</div>
                                            <div id="summary-delivery-time" class="small fw-500">Créneau à définir</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="bi bi-geo-alt-fill me-2"></i>Adresse de collecte</h5></div>
                                <div class="card-body">
                                    <div id="summary-collection-address" class="small">À définir</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                             <div class="card h-100">
                                <div class="card-header"><h5 class="mb-0"><i class="bi bi-truck me-2"></i>Adresse de livraison</h5></div>
                                <div class="card-body">
                                    <div id="summary-delivery-address" class="small">À définir</div>
                                     @if(isset($tempCart['delivery_notes']) && !empty($tempCart['delivery_notes']))
                                        <p class="mt-2 mb-0 small text-muted"><strong>Notes :</strong> <span id="summary-delivery-notes">{{ $tempCart['delivery_notes'] }}</span></p>
                                    @else
                                        <p class="mt-2 mb-0 small text-muted" id="summary-delivery-notes-container" style="display:none;"><strong>Notes :</strong> <span id="summary-delivery-notes"></span></p>
                                    @endif
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header"><h5 class="mb-0"><i class="bi bi-card-checklist me-2"></i>Services sélectionnés</h5></div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-striped mb-0">
                                    <thead>
                                        <tr>
                                            <th class="ps-3">Service</th>
                                            <th class="text-center">Qté</th>
                                            <th class="text-center">P.U.</th>
                                            <th class="text-end pe-3">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody id="summary-items">
                                        {{-- Rempli par JS --}}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="3" class="text-end border-0 pt-1 ps-3">Sous-total :</td>
                                            <td class="text-end border-0 pt-1 pe-3" id="summary-subtotal">0 FCFA</td>
                                        </tr>
                                        <tr>
                                            <td colspan="3" class="text-end border-0 pt-1 ps-3">Frais de livraison :</td>
                                            <td class="text-end border-0 pt-1 pe-3" id="summary-delivery-fees">0 FCFA</td>
                                        </tr>
                                        <tr id="summary-discount-row" style="display: none;">
                                            <td colspan="3" class="text-end border-0 pt-1 ps-3 text-success">Réduction :</td>
                                            <td class="text-end border-0 pt-1 pe-3 text-success" id="summary-discount">-0 FCFA</td>
                                        </tr>
                                        <tr class="text-klin-primary">
                                            <td colspan="3" class="text-end border-0 pt-2 ps-3 fw-bold">TOTAL :</td>
                                            <td class="text-end border-0 pt-2 pe-3 fw-bold fs-4" id="summary-total">0 FCFA</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-step" id="step-5">
                    <h3 class="text-klin-primary"><i class="bi bi-credit-card-fill"></i> Mode de paiement</h3>
                    <div class="text-center mb-4">
                        <h4>Total à payer : <span id="payment-total" class="text-klin-primary fw-bold">0 FCFA</span></h4>
                        <div class="d-flex justify-content-center gap-3 mt-2 mb-4">
                            <span class="badge rounded-pill bg-light text-dark border px-3 py-2">
                                <i class="bi bi-basket3-fill me-1 text-klin-primary"></i> Services : <span id="payment-subtotal" class="fw-bold">0 FCFA</span>
                            </span>
                            <span class="badge rounded-pill bg-light text-dark border px-3 py-2">
                                <i class="bi bi-currency-exchange me-1 text-klin-primary"></i> Collecte : <span id="payment-pickup-fee" class="fw-bold">0 FCFA</span>
                            </span>
                            <span class="badge rounded-pill bg-light text-dark border px-3 py-2">
                                <i class="bi bi-truck me-1 text-klin-primary"></i> Livraison : <span id="payment-delivery-fee" class="fw-bold">0 FCFA</span>
                            </span>
                            <span class="badge rounded-pill bg-light text-success border px-3 py-2" id="payment-discount-badge" style="display: none;">
                                <i class="bi bi-percent me-1"></i> Réduction : <span id="payment-discount" class="fw-bold">-0 FCFA</span>
                            </span>
                        </div>
                        <p class="text-muted">Choisissez comment vous souhaitez régler votre commande.</p>
                    </div>
                    
                    <!-- Section des bons de livraison avec design amélioré -->
                    <div class="row justify-content-center mb-4">
                        <div class="col-md-8">
                            <div class="card shadow-sm">
                                <div class="card-header bg-light d-flex align-items-center">
                                    <i class="bi bi-ticket-perforated fs-3 text-klin-primary me-2"></i>
                                    <h5 class="mb-0">Bon de livraison</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="use_delivery_voucher" name="use_delivery_voucher" value="1" 
                                            @if(old('use_delivery_voucher', $tempCart['use_delivery_voucher'] ?? false)) checked @endif>
                                        <label class="form-check-label" for="use_delivery_voucher">
                                            Utiliser un bon de livraison pour bénéficier d'une livraison gratuite
                                        </label>
                                    </div>
                                    
                                    <div id="voucher_fields" @if(!old('use_delivery_voucher', $tempCart['use_delivery_voucher'] ?? false)) style="display: none;" @endif>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="delivery_voucher_code" name="delivery_voucher_code" 
                                                placeholder="Code du bon" value="{{ old('delivery_voucher_code', $tempCart['delivery_voucher_code'] ?? '') }}">
                                            <button class="btn klin-btn" type="button" id="apply_voucher">
                                                <i class="bi bi-check-circle-fill me-1"></i> Appliquer
                                            </button>
                                        </div>
                                        <div id="delivery_voucher_message"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section des codes promo -->
                    <div class="row justify-content-center mb-4">
                        <div class="col-md-8">
                            <div class="card shadow-sm">
                                <div class="card-header bg-light d-flex align-items-center">
                                    <i class="bi bi-percent fs-3 text-success me-2"></i>
                                    <h5 class="mb-0">Code promo</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="use_coupon" name="use_coupon" value="1" 
                                            @if(old('use_coupon', $tempCart['use_coupon'] ?? false)) checked @endif>
                                        <label class="form-check-label" for="use_coupon">
                                            Appliquer un code promo pour bénéficier d'une réduction
                                        </label>
                                    </div>
                                    
                                    <div id="coupon_fields" @if(!old('use_coupon', $tempCart['use_coupon'] ?? false)) style="display: none;" @endif>
                                        <div class="input-group mb-3">
                                            <input type="text" class="form-control" id="coupon_code" name="coupon_code" 
                                                placeholder="Code promo" value="{{ old('coupon_code', $tempCart['coupon_code'] ?? '') }}">
                                            <button class="btn klin-btn" type="button" id="apply_coupon">
                                                <i class="bi bi-check-circle-fill me-1"></i> Appliquer
                                            </button>
                                        </div>
                                        <div id="coupon_message"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row justify-content-center g-4">
                        <div class="col-md-4 col-sm-6">
                            <input class="form-check-input" type="radio" name="payment_method" id="payment-cash" value="cash" checked>
                            <label class="form-check-label text-center h-100" for="payment-cash">
                                <div class="card shadow-sm hover-card h-100">
                                    <div class="card-body p-4">
                                        <i class="bi bi-cash-stack text-success fs-2 mb-3 d-block"></i>
                                        <strong class="d-block fs-5 mb-2">Paiement à la livraison</strong>
                                        <div class="text-muted small">Payez en espèces ou par mobile money (selon disponibilité du livreur) lors de la réception de votre linge propre.</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <input class="form-check-input" type="radio" name="payment_method" id="payment-quota" value="quota" {{ Auth::user()->getTotalAvailableQuota() > 0 ? '' : 'disabled' }}>
                            <label class="form-check-label text-center h-100 {{ Auth::user()->getTotalAvailableQuota() > 0 ? '' : 'opacity-50' }}" for="payment-quota">
                                <div class="card shadow-sm hover-card h-100">
                                    <div class="card-body p-4">
                                        <i class="bi bi-gift-fill text-primary fs-2 mb-3 d-block"></i>
                                        <strong class="d-block fs-5 mb-2">Utiliser mon quota</strong>
                                        <div class="text-muted small">
                                            @if(Auth::user()->getTotalAvailableQuota() > 0)
                                                Quota disponible: <span class="fw-bold">{{ Auth::user()->getTotalAvailableQuota() }} kg</span>
                                                <div class="mt-1 fw-bold" id="quota-equivalent"></div>
                                            @else
                                                Vous n'avez pas de quota disponible. Souscrivez à un abonnement pour bénéficier de quota.
                                            @endif
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <div class="col-md-4 col-sm-6">
                            <input class="form-check-input" type="radio" name="payment_method" id="payment-mobile" value="mobile_money" disabled>
                            <label class="form-check-label text-center h-100 opacity-50" for="payment-mobile">
                                <div class="card shadow-sm h-100">
                                    <div class="card-body p-4">
                                        <i class="bi bi-phone-fill text-muted fs-2 mb-3 d-block"></i>
                                        <strong class="d-block fs-5 mb-2">Mobile Money (en ligne)</strong>
                                        <div class="text-muted small">Service de paiement en ligne temporairement indisponible.</div>
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-5 pt-4 border-top">
                    <button type="button" class="btn klin-btn-outline prev-step px-4" style="display: none;">
                        <i class="bi bi-arrow-left-circle me-2"></i>Précédent
                    </button>
                    <button type="button" class="btn klin-btn next-step ms-auto px-4 py-2" id="next-step-button">
                        Suivant<i class="bi bi-arrow-right-circle ms-2"></i>
                    </button>
                    <button type="submit" class="btn klin-btn submit-order ms-auto px-4 py-2" id="submit-order-button" style="display: none;">
                        <i class="bi bi-check-circle me-2"></i>Finaliser la commande
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
@endsection

@push('scripts')
{{-- Le script JavaScript reste le même que dans la version précédente, car il gère la logique des étapes, 
    la sélection des services, et la mise à jour des totaux.
    Assurez-vous qu'il est bien inclus et fonctionne correctement.
    Les principales modifications de design sont dans le HTML et le CSS.
--}}
<script>
    console.log("Début du script de commande pressing - DOM Loading");
    
    // Déclaration des variables clés comme globales pour assurer l'accessibilité
    var currentStep = {{ old('current_step', $tempCart['step'] ?? 0) }};
    var totalSteps = 6;
    var pressingServices = @json($pressingServices ?? []);
    var pressingCategories = @json($serviceCategories ?? []);
    var tempCartItems = @json($tempCart['pressing_services'] ?? []);
    var currentDeliveryFee = 0;
    var deliveryFees = @json($deliveryFees ?? []);

    // Déterminer si nous sommes sur une page de pressing spécifique
    var pressingId = {{ $pressingId ?? 'null' }};
    
    // Si nous sommes sur l'URL principale sans pressing spécifique, être sûr de montrer l'étape 0
    if (pressingId === null) {
        currentStep = 0;
    }
    // Si un ID de pressing est présent, forcer l'étape 1 (collecte)
    else if (pressingId !== null) {
        currentStep = 1;
    }

    // Fonction principale de mise à jour des étapes
    function updateStep() {
        // Récupérer les éléments DOM
        const steps = document.querySelectorAll('.form-step');
        const progressSteps = document.querySelectorAll('.progress-bar-custom .step-custom');
        const progressLines = document.querySelectorAll('.progress-bar-custom .progress-line-custom');
        const prevBtn = document.querySelector('.prev-step');
        const nextBtn = document.querySelector('.next-step');
        const submitBtn = document.querySelector('.submit-order');
        
        // Mise à jour des étapes visibles
        steps.forEach((step, index) => {
            step.classList.toggle('active', index === currentStep);
        });

        // Mise à jour du bouton précédent
        prevBtn.style.display = currentStep === 0 ? 'none' : 'inline-flex';
        
        // Gestion des boutons suivant/finaliser selon l'étape
        const isLastStep = currentStep === totalSteps - 1;
        
        // Afficher le bouton approprié
        nextBtn.style.display = isLastStep ? 'none' : 'inline-flex';
        submitBtn.style.display = isLastStep ? 'inline-flex' : 'none';
        
        // Mise à jour de l'indicateur de progression
        progressSteps.forEach((step, index) => {
            const iconContainer = step.querySelector('.step-icon span i');
            step.classList.remove('active', 'completed');
            
            if (index < currentStep) {
                step.classList.add('completed');
                if(iconContainer) iconContainer.className = 'bi bi-check-lg';
            } else if (index === currentStep) {
                step.classList.add('active');
                // Remettre l'icône originale pour l'étape active
                const originalIcons = ["bi-shop", "bi-geo-alt-fill", "bi-truck", "bi-card-checklist", "bi-receipt", "bi-credit-card-fill"];
                if(iconContainer) iconContainer.className = `bi ${originalIcons[index]}`;
            } else {
                // Remettre l'icône originale pour les étapes futures
                const originalIcons = ["bi-shop", "bi-geo-alt-fill", "bi-truck", "bi-card-checklist", "bi-receipt", "bi-credit-card-fill"];
                if(iconContainer) iconContainer.className = `bi ${originalIcons[index]}`;
            }
        });

        progressLines.forEach((line, index) => {
            line.classList.toggle('active', index < currentStep);
        });

        // Initialisation spécifique en fonction des étapes
        if (currentStep === 0) initializePressingSelection();
        if (currentStep === 3) initializePressingServicesAndCategories();
        if (currentStep === 4) updateFullSummary(); // Récap
        if (currentStep === 5) {
            // Paiement - Mettre à jour les montants
            const paymentTotalDisplay = document.getElementById('payment-total');
            const paymentSubtotalDisplay = document.getElementById('payment-subtotal');
            const paymentPickupFeeDisplay = document.getElementById('payment-pickup-fee');
            const paymentDeliveryFeeDisplay = document.getElementById('payment-delivery-fee');
            
            // Récupérer les montants du récapitulatif
            const subtotal = parseFloat(document.getElementById('summary-subtotal').textContent.replace(/\s/g, '').replace('FCFA', '')) || 0;
            const deliveryFees = calculateDeliveryFee();
            const totalPrice = parseFloat(document.getElementById('summary-total').textContent.replace(/\s/g, '').replace('FCFA', '')) || 0;
            
            // Mettre à jour les affichages
            if (paymentSubtotalDisplay) paymentSubtotalDisplay.textContent = new Intl.NumberFormat('fr-FR').format(subtotal) + " FCFA";
            if (paymentPickupFeeDisplay) paymentPickupFeeDisplay.textContent = new Intl.NumberFormat('fr-FR').format(deliveryFees.pickup) + " FCFA";
            if (paymentDeliveryFeeDisplay) paymentDeliveryFeeDisplay.textContent = new Intl.NumberFormat('fr-FR').format(deliveryFees.delivery) + " FCFA";
            if (paymentTotalDisplay) paymentTotalDisplay.textContent = new Intl.NumberFormat('fr-FR').format(totalPrice) + " FCFA";
            
            // Vérifier le quota
            calculateQuotaEquivalent();
        }
    }
    
    // Fonction pour naviguer vers une étape spécifique
    function goToStep(step) {
        if (step >= 0 && step < totalSteps) {
            console.log("Tentative de navigation vers l'étape:", step, "depuis:", currentStep);
            
            // Sur la page principale, on doit toujours rester à l'étape 0
            if (window.location.pathname === '/orders/create/pressing' && step > 0) {
                console.log("Navigation bloquée - sélectionnez d'abord un pressing");
                return false;
            }
            
            // Validation requise seulement quand on avance
            if (step > currentStep && !validateStep(currentStep)) {
                return false; // Ne pas avancer si l'étape actuelle n'est pas valide
            }
            
            // Si on tente d'aller au-delà de la dernière étape, c'est pour soumettre le formulaire
            if (step >= totalSteps) {
                console.log("Soumission du formulaire");
                document.getElementById('orderForm').submit();
                return true;
            }
            
            currentStep = step;
            updateStep();
            window.scrollTo(0, 0);
            return true;
        }
        return false;
    }
    
    // Validation des étapes
    function validateStep(stepIndex) {
        let isValid = true;
        const steps = document.querySelectorAll('.form-step');
        const stepElement = steps[stepIndex];
        
        // Vérifier les champs requis
        stepElement.querySelectorAll('[required]').forEach(input => {
            if (!input.value && input.offsetParent !== null) { // Vérifier si visible
                isValid = false;
                input.classList.add('is-invalid');
            } else {
                input.classList.remove('is-invalid');
            }
        });

        // Validations spécifiques par étape
        if (stepIndex === 0) { // Sélection Pressing
            const pressingId = document.getElementById('selected_pressing_id_field').value;
            if (!pressingId) {
                isValid = false;
                
                // Afficher un message d'erreur
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-3';
                errorDiv.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Erreur :</strong> Veuillez sélectionner un pressing avant de continuer.';
                
                // Vérifier si un message d'erreur existe déjà
                const existingError = document.querySelector('#step-0 .alert.alert-danger');
                if (!existingError) {
                    document.querySelector('#step-0').appendChild(errorDiv);
                    
                    // Supprimer le message après 3 secondes
                    setTimeout(() => {
                        errorDiv.remove();
                    }, 3000);
                }
            }
        }
        
        if (stepIndex === 1) { // Collecte
            // Trigger delivery fee calculation on validation
            calculateDeliveryFee();
        }
        
        if (stepIndex === 2) { // Livraison
            // Trigger delivery fee calculation on validation
            calculateDeliveryFee();
        }
        
        if (stepIndex === 3) { // Services
            let servicesSelected = false;
            document.querySelectorAll('.item-quantity').forEach(input => {
                const quantity = parseInt(input.value);
                if (quantity > 0) servicesSelected = true;
            });
            
            if (!servicesSelected) {
                isValid = false;
                
                // Afficher un message d'erreur
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-3';
                errorDiv.innerHTML = '<i class="bi bi-exclamation-triangle-fill me-2"></i><strong>Erreur :</strong> Veuillez sélectionner au moins un service avant de continuer.';
                
                // Vérifier si un message d'erreur existe déjà
                const existingError = document.querySelector('#step-3 .alert.alert-danger');
                if (!existingError) {
                    document.querySelector('#step-3').appendChild(errorDiv);
                    
                    // Supprimer le message après 3 secondes
                    setTimeout(() => {
                        errorDiv.remove();
                    }, 3000);
                }
            }
        }
        
        return isValid;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Log current step for debugging
        console.log("currentStep at DOM loaded:", currentStep, "pressingId:", pressingId);
        
        // Enforce correct step based on URL
        if (window.location.pathname === '/orders/create/pressing') {
            // Main page - force step 0
            currentStep = 0;
            console.log("Enforcing step 0 for main pressing page");
        }
        
        // Mise à jour immédiate de l'étape
        updateStep();
        
        const orderForm = document.getElementById('orderForm');
        const prevBtn = document.querySelector('.prev-step');
        const nextBtn = document.querySelector('.next-step');
        const submitBtn = document.querySelector('.submit-order');
        
        // Gestionnaire d'événements pour le bouton de soumission
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Vérifier la validation de l'étape finale
            if (validateStep(currentStep)) {
                console.log("Soumission du formulaire");
                orderForm.submit();
            }
        });
        
        // Remplacer le gestionnaire du bouton suivant
        nextBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            console.log("Bouton suivant cliqué, étape actuelle:", currentStep);
            
            // Pour l'étape 0 (sélection du pressing), rediriger vers la page du pressing sélectionné
            if (currentStep === 0) {
                const pressingId = document.getElementById('selected_pressing_id_field').value;
                if (pressingId) {
                    // Redirection directe vers la route du pressing
                    window.location.href = "/orders/create/pressing/" + pressingId;
                    return;
                } else {
                    alert("Veuillez d'abord sélectionner un pressing en cliquant sur une carte");
                    return;
                }
            }
            
            // Pour toutes les autres étapes, utiliser goToStep pour une validation cohérente
            goToStep(currentStep + 1);
        });

        // Gestionnaire d'événements pour le bouton précédent
        prevBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Sur la page principale pressing, ne pas permettre de revenir en arrière
            if (window.location.pathname === '/orders/create/pressing' && currentStep === 0) {
                return;
            }
            
            // Sur les autres pages, retour à l'étape précédente
            goToStep(currentStep - 1);
        });
        
        // --- Logique pour la sélection du Pressing (Étape 0) ---
        document.querySelectorAll('.pressing-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // Ignore click if it's on the select button (let the native link behavior work)
                if (e.target.closest('.select-pressing-btn')) {
                    return;
                }
                
                // Récupérer l'ID du pressing directement de l'attribut data
                const pressingId = this.dataset.pressingId;
                console.log('Carte pressing cliquée, ID:', pressingId);
                
                // Mettre à jour le champ caché
                document.getElementById('selected_pressing_id_field').value = pressingId;
                
                // Extraire et mettre à jour l'affichage du nom du pressing
                const pressingName = this.querySelector('.card-title').textContent;
                const pressingAddress = this.querySelector('.card-text.small').textContent;
                document.getElementById('selected_pressing_display').value = pressingName + " - " + pressingAddress;
                
                // Mettre à jour la sélection visuelle
                document.querySelectorAll('.pressing-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                
                // Activer le bouton "Suivant" car un pressing est maintenant sélectionné
                document.querySelector('.next-step').disabled = false;
                
                // Rediriger directement vers la page du pressing sélectionné
                window.location.href = "/orders/create/pressing/" + pressingId;
            });
        });
        
        // Gérer directement les clics sur le bouton de sélection
        document.querySelectorAll('.select-pressing-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                // Le bouton a déjà un href, pas besoin de gérer la redirection
                // Mais on peut mettre à jour l'état visuel si souhaité
                const pressingCard = this.closest('.pressing-card');
                if (pressingCard) {
                    document.querySelectorAll('.pressing-card').forEach(c => c.classList.remove('selected'));
                    pressingCard.classList.add('selected');
                }
            });
        });

        // Gérer l'affichage des champs d'adresse de livraison en fonction de la case à cocher
        const sameAddressCheckbox = document.getElementById('same_address_for_delivery_step2');
        if (sameAddressCheckbox) {
            sameAddressCheckbox.addEventListener('change', function() {
                const deliveryAddressFields = document.getElementById('delivery-address-fields');
                if (deliveryAddressFields) {
                    deliveryAddressFields.style.display = this.checked ? 'none' : 'block';
                    
                    // Gérer les attributs requis
                    const deliveryAddressSelect = document.getElementById('delivery_address_id');
                    if (deliveryAddressSelect) {
                        if (this.checked) {
                            deliveryAddressSelect.removeAttribute('required');
                        } else {
                            deliveryAddressSelect.setAttribute('required', 'required');
                        }
                    }
                }
                
                // Recalculer les frais de livraison
                calculateDeliveryFee();
            });
        }

        // Gérer les événements pour le calcul des frais de livraison
        const collectionAddressSelect = document.getElementById('collection_address_id');
        const deliveryAddressSelect = document.getElementById('delivery_address_id');
        
        if (collectionAddressSelect) {
            collectionAddressSelect.addEventListener('change', calculateDeliveryFee);
        }
        
        if (deliveryAddressSelect) {
            deliveryAddressSelect.addEventListener('change', calculateDeliveryFee);
        }
    });
    
    function initializePressingServicesAndCategories() {
        console.log("Initialisation des services et catégories du pressing");
        const pressingId = document.getElementById('selected_pressing_id_field').value;
        
        if (!pressingId) {
            showErrorInServices("Veuillez d'abord sélectionner un pressing à l'étape précédente.");
            return;
        }
        
        if (pressingServices.length === 0) {
            // Si les services ne sont pas encore chargés, les charger via AJAX
            showErrorInServices("Chargement des services en cours...");
            
            fetch(`/api/pressings/${pressingId}/new-services`)
                .then(response => {
                    console.log("Response status:", response.status);
                    return response.json();
                })
                .then(data => {
                    console.log("Data received:", data);
                    if (data.services && data.services.length > 0) {
                        pressingServices = data.services;
                        pressingCategories = data.categories || [];
                        renderCategories(pressingCategories);
                        renderServices(pressingServices, 'all');
                        loadTempCartItems();
                        updateTotals();
                    } else {
                        showErrorInServices("Aucun service disponible pour ce pressing.");
                    }
                })
                .catch(error => {
                    console.error("Erreur lors du chargement des services:", error);
                    showErrorInServices("Erreur lors du chargement des services. Veuillez réessayer.");
                });
        } else {
            // Sinon, utiliser les services déjà chargés
            renderCategories(pressingCategories);
            renderServices(pressingServices, 'all');
            loadTempCartItems();
            updateTotals();
        }
    }
    
    function renderServices(servicesToRender, categoryFilter = 'all') {
        const servicesContainer = document.getElementById('servicesContainer');
        if (!servicesContainer) {
            console.error("Conteneur de services introuvable");
            return;
        }
        
        servicesContainer.innerHTML = '';
        
        if (!servicesToRender || servicesToRender.length === 0) {
            let message = categoryFilter === 'all' 
                ? "Aucun service disponible pour ce pressing."
                : "Aucun service disponible dans cette catégorie.";
            
            showErrorInServices(message);
            return;
        }

        // Générer les éléments HTML pour chaque service
        servicesToRender.forEach(service => {
            const serviceElement = document.createElement('div');
            serviceElement.className = 'col-md-6 mb-3 service-item';
            serviceElement.dataset.categoryId = service.service_category_id || service.category_id || '';
            
            const price = parseFloat(service.price) || 0;
            const formattedPrice = new Intl.NumberFormat('fr-FR').format(price) + " FCFA";
            
            serviceElement.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h5 class="card-title mb-1">${service.name}</h5>
                            <span class="badge rounded-pill" style="background-color: var(--klin-primary); color:white;">${formattedPrice}</span>
                        </div>
                        <p class="card-text text-muted"><small>${service.description || ''}</small></p>
                        <div class="input-group mt-auto">
                            <button type="button" class="btn btn-outline-secondary quantity-minus" aria-label="Diminuer la quantité"><i class="bi bi-dash-lg"></i></button>
                            <input type="number" class="form-control text-center item-quantity" 
                                name="pressing_services[${service.id}][quantity]" value="0" min="0" 
                                data-price="${price}" data-service-id="${service.id}" aria-label="Quantité pour ${service.name}">
                            <button type="button" class="btn btn-outline-secondary quantity-plus" aria-label="Augmenter la quantité"><i class="bi bi-plus-lg"></i></button>
                        </div>
                    </div>
                </div>`;
            
            servicesContainer.appendChild(serviceElement);
        });
        
        // Attacher les écouteurs d'événements aux boutons de quantité
        attachQuantityListeners();
    }

    // Fonction pour afficher des erreurs lors du chargement des services
    function showErrorInServices(message) {
        const servicesContainer = document.getElementById('servicesContainer');
        if (!servicesContainer) return;
        
        servicesContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> ${message}
                </div>
            </div>`;
    }
    
    function renderCategories(categories) {
        const categoriesList = document.getElementById('categories-list');
        if (!categoriesList) {
            console.error("Conteneur de catégories introuvable");
            return;
        }
        
        // Garder uniquement la catégorie "Tous les services"
        categoriesList.innerHTML = `
            <a href="#" class="list-group-item list-group-item-action category-tab active" data-category="all">
                <i class="bi bi-grid-fill icon"></i> Tous les services
            </a>`;
            
        // Ajouter les catégories
        if (categories && categories.length > 0) {
            categories.forEach(category => {
                const categoryElement = document.createElement('a');
                categoryElement.href = "#";
                categoryElement.className = "list-group-item list-group-item-action category-tab";
                categoryElement.dataset.category = category.id || category.name;
                
                categoryElement.innerHTML = `
                    <i class="bi ${category.icon || 'bi-tag'} icon"></i> ${category.name}`;
                
                categoriesList.appendChild(categoryElement);
            });
            
            // Ajouter les écouteurs d'événements pour les onglets de catégorie
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Mettre à jour la classe active
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Filtrer les services par catégorie
                    const categoryId = this.dataset.category;
                    
                    if (categoryId === 'all') {
                        renderServices(pressingServices, 'all');
                    } else {
                        const filteredServices = pressingServices.filter(service => 
                            (service.category_id === categoryId) || 
                            (service.service_category_id === categoryId) ||
                            (service.category === categoryId)
                        );
                        renderServices(filteredServices, categoryId);
                    }
                });
            });
        } else {
            console.log("Aucune catégorie disponible");
        }
    }
    
    function attachQuantityListeners() {
        // Attacher les événements d'incrémentation et décrémentation
        document.querySelectorAll('.quantity-plus').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.parentElement.querySelector('.item-quantity');
                const currentValue = parseInt(input.value) || 0;
                input.value = currentValue + 1;
                
                // Déclencher l'événement de changement pour mettre à jour les totaux
                const event = new Event('change', { bubbles: true });
                input.dispatchEvent(event);
            });
        });
        
        document.querySelectorAll('.quantity-minus').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.parentElement.querySelector('.item-quantity');
                const currentValue = parseInt(input.value) || 0;
                if (currentValue > 0) {
                    input.value = currentValue - 1;
                    
                    // Déclencher l'événement de changement pour mettre à jour les totaux
                    const event = new Event('change', { bubbles: true });
                    input.dispatchEvent(event);
                }
            });
        });
        
        // Attacher les événements de changement pour mettre à jour les totaux
        document.querySelectorAll('.item-quantity').forEach(input => {
            input.addEventListener('change', function() {
                updateTotals();
            });
        });
    }
    
    function updateTotals() {
        let subtotal = 0;
        
        // Calculer le sous-total des services
        document.querySelectorAll('.item-quantity').forEach(input => {
            const quantity = parseInt(input.value) || 0;
            const price = parseFloat(input.dataset.price) || 0;
            subtotal += quantity * price;
        });
        
        // Calculer les frais de livraison
        const deliveryFeeObj = calculateDeliveryFee();
        
        // Vérifier si un bon de livraison est utilisé
        const useVoucherCheckbox = document.getElementById('use_delivery_voucher');
        if (useVoucherCheckbox && useVoucherCheckbox.checked) {
            // Si un bon est utilisé, annuler les frais de livraison
            deliveryFeeObj.pickup = 0;
            deliveryFeeObj.delivery = 0;
            deliveryFeeObj.total = 0;
        }
        
        // Calculer le total avec ou sans frais de livraison
        const totalPrice = subtotal + deliveryFeeObj.total;
        
        // Mettre à jour l'affichage du prix estimé
        const estimatedPriceDisplay = document.getElementById('estimatedPriceDisplay');
        if (estimatedPriceDisplay) {
            estimatedPriceDisplay.textContent = new Intl.NumberFormat('fr-FR').format(totalPrice);
        }
        
        // Sauvegarder les services sélectionnés pour le récapitulatif
        window.selectedServices = [];
        document.querySelectorAll('.item-quantity').forEach(input => {
            const quantity = parseInt(input.value) || 0;
            if (quantity > 0) {
                const serviceId = input.dataset.serviceId;
                const price = parseFloat(input.dataset.price) || 0;
                const serviceTitle = input.closest('.card').querySelector('.card-title').textContent;
                
                window.selectedServices.push({
                    id: serviceId,
                    name: serviceTitle,
                    price: price,
                    quantity: quantity,
                    total: price * quantity
                });
            }
        });
    }
    
    function loadTempCartItems() {
        if (tempCartItems && Object.keys(tempCartItems).length > 0) {
            // Parcourir les articles du panier temporaire
            Object.keys(tempCartItems).forEach(serviceId => {
                const item = tempCartItems[serviceId];
                const quantityInput = document.querySelector(`.item-quantity[data-service-id="${serviceId}"]`);
                
                if (quantityInput && item.quantity) {
                    quantityInput.value = item.quantity;
                }
            });
            
            // Mettre à jour les totaux
            updateTotals();
        }
    }

    function initializePressingSelection() {
        // Si un ID de pressing est présent dans le champ caché, marquer la carte correspondante comme sélectionnée
        const selectedPressingId = document.getElementById('selected_pressing_id_field').value;
        
        if (selectedPressingId) {
            console.log("Sélection du pressing avec ID:", selectedPressingId);
            
            const pressingCard = document.querySelector(`.pressing-card[data-pressing-id="${selectedPressingId}"]`);
            if (pressingCard) {
                // Mettre à jour la sélection visuelle
                document.querySelectorAll('.pressing-card').forEach(c => c.classList.remove('selected'));
                pressingCard.classList.add('selected');
            }
        }
    }

    // Calculate delivery fees based on selected addresses
    function calculateDeliveryFee() {
        // Default base fees
        const baseFee = 1000; // Base fee in FCFA
        let pickupFee = baseFee;
        let deliveryFee = baseFee;
        let totalFee = 0;
        
        // Get selected addresses
        const collectionAddressSelect = document.getElementById('collection_address_id');
        const deliveryAddressSelect = document.getElementById('delivery_address_id');
        const sameAddressCheckbox = document.getElementById('same_address_for_delivery_step2');
        
        // Get neighborhood from selected collection address
        let collectionNeighborhood = '';
        if (collectionAddressSelect && collectionAddressSelect.selectedIndex > 0) {
            const selectedOption = collectionAddressSelect.options[collectionAddressSelect.selectedIndex];
            const addressText = selectedOption.textContent;
            // Extract neighborhood (assuming format like "Name - Address, Neighborhood")
            const matches = addressText.match(/,\s*([^,]+)$/);
            if (matches && matches.length > 1) {
                collectionNeighborhood = matches[1].trim();
            }
        }
        
        // Get neighborhood from selected delivery address or use collection if same
        let deliveryNeighborhood = '';
        if (sameAddressCheckbox && sameAddressCheckbox.checked) {
            // Use same neighborhood as collection
            deliveryNeighborhood = collectionNeighborhood;
        } else if (deliveryAddressSelect && deliveryAddressSelect.selectedIndex > 0) {
            const selectedOption = deliveryAddressSelect.options[deliveryAddressSelect.selectedIndex];
            const addressText = selectedOption.textContent;
            // Extract neighborhood
            const matches = addressText.match(/,\s*([^,]+)$/);
            if (matches && matches.length > 1) {
                deliveryNeighborhood = matches[1].trim();
            }
        }
        
        // Récupérer les frais de livraison depuis l'API si disponible
        if (window.deliveryFeesData && window.deliveryFeesData.length > 0) {
            // Utiliser les données déjà chargées
            applyDeliveryFees(window.deliveryFeesData, collectionNeighborhood, deliveryNeighborhood);
        } else {
            // Récupérer les frais de livraison depuis l'API
            fetch('/api/delivery-fees')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.fees) {
                        window.deliveryFeesData = data.fees;
                        applyDeliveryFees(data.fees, collectionNeighborhood, deliveryNeighborhood);
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la récupération des frais de livraison:', error);
                });
        }
        
        // Fonction pour appliquer les frais de livraison
        function applyDeliveryFees(fees, collectionNeighborhood, deliveryNeighborhood) {
            // Chercher le frais pour le quartier de collecte
            const pickupFeeData = fees.find(fee => 
                fee.district.toLowerCase() === collectionNeighborhood.toLowerCase()
            );
            
            // Chercher le frais pour le quartier de livraison
            const deliveryFeeData = fees.find(fee => 
                fee.district.toLowerCase() === deliveryNeighborhood.toLowerCase()
            );
            
            // Appliquer les frais si trouvés
            if (pickupFeeData) {
                pickupFee = pickupFeeData.fee;
            }
            
            if (deliveryFeeData) {
                deliveryFee = deliveryFeeData.fee;
            }
            
            // Calculer le total
            totalFee = pickupFee + deliveryFee;
            
            // Mettre à jour l'affichage
            updateDeliveryFeeDisplay();
        }
        
        // Fonction pour mettre à jour l'affichage des frais
        function updateDeliveryFeeDisplay() {
            // Display fees in collection and delivery fee info elements
            const collectionFeeInfo = document.getElementById('collection-address-fee-info');
            const deliveryFeeInfo = document.getElementById('delivery-address-fee-info');
            
            if (collectionFeeInfo) {
                collectionFeeInfo.textContent = `Frais de collecte: ${new Intl.NumberFormat('fr-FR').format(pickupFee)} FCFA`;
                collectionFeeInfo.style.display = 'block';
            }
            
            if (deliveryFeeInfo) {
                deliveryFeeInfo.textContent = `Frais de livraison: ${new Intl.NumberFormat('fr-FR').format(deliveryFee)} FCFA`;
                deliveryFeeInfo.style.display = 'block';
            }
            
            // Mettre à jour les totaux si nécessaire
            updateTotals();
        }
        
        return {
            pickup: pickupFee,
            delivery: deliveryFee,
            total: totalFee
        };
    }

    function updateFullSummary() {
        // Récupérer les valeurs des champs
        const pressing = document.getElementById('selected_pressing_display').value || 'Non sélectionné';
        
        // Adresses
        const collectionAddressSelect = document.getElementById('collection_address_id');
        const deliveryAddressSelect = document.getElementById('delivery_address_id');
        const sameAddressCheckbox = document.getElementById('same_address_for_delivery_step2');
        
        let collectionAddress = 'Non sélectionnée';
        let deliveryAddress = 'Non sélectionnée';
        
        if (collectionAddressSelect && collectionAddressSelect.selectedIndex > 0) {
            collectionAddress = collectionAddressSelect.options[collectionAddressSelect.selectedIndex].textContent;
        }
        
        if (sameAddressCheckbox && sameAddressCheckbox.checked) {
            deliveryAddress = collectionAddress + ' (même que la collecte)';
        } else if (deliveryAddressSelect && deliveryAddressSelect.selectedIndex > 0) {
            deliveryAddress = deliveryAddressSelect.options[deliveryAddressSelect.selectedIndex].textContent;
        }
        
        // Dates
        const collectionDate = document.getElementById('collection_date');
        const collectionTimeSlot = document.getElementById('collection_time_slot');
        const deliveryDate = document.getElementById('delivery_date');
        const deliveryTimeSlot = document.getElementById('delivery_time_slot');
        
        // Notes
        const deliveryNotes = document.getElementById('delivery_notes');
        
        // Mettre à jour les adresses
        document.getElementById('summary-pressing-name').textContent = pressing;
        document.getElementById('summary-collection-address').textContent = collectionAddress;
        document.getElementById('summary-delivery-address').textContent = deliveryAddress;
        
        // Mettre à jour les dates
        if (collectionDate && collectionDate.value) {
            const formattedDate = new Date(collectionDate.value).toLocaleDateString('fr-FR', { 
                day: '2-digit', month: '2-digit', year: 'numeric' 
            });
            document.getElementById('summary-collection-date').textContent = formattedDate;
        }
        
        if (collectionTimeSlot && collectionTimeSlot.selectedIndex > 0) {
            document.getElementById('summary-collection-time').textContent = collectionTimeSlot.options[collectionTimeSlot.selectedIndex].textContent;
        }
        
        if (deliveryDate && deliveryDate.value) {
            const formattedDate = new Date(deliveryDate.value).toLocaleDateString('fr-FR', { 
                day: '2-digit', month: '2-digit', year: 'numeric' 
            });
            document.getElementById('summary-delivery-date').textContent = formattedDate;
        }
        
        if (deliveryTimeSlot && deliveryTimeSlot.selectedIndex > 0) {
            document.getElementById('summary-delivery-time').textContent = deliveryTimeSlot.options[deliveryTimeSlot.selectedIndex].textContent;
        }
        
        // Afficher les notes de livraison si présentes
        if (deliveryNotes && deliveryNotes.value) {
            document.getElementById('summary-delivery-notes').textContent = deliveryNotes.value;
            document.getElementById('summary-delivery-notes-container').style.display = 'block';
        } else {
            document.getElementById('summary-delivery-notes-container').style.display = 'none';
        }
        
        // Afficher les services sélectionnés
        const summaryItems = document.getElementById('summary-items');
        if (summaryItems) {
            summaryItems.innerHTML = '';
            
            if (window.selectedServices && window.selectedServices.length > 0) {
                let subtotal = 0;
                
                window.selectedServices.forEach(service => {
                    const row = document.createElement('tr');
                    const formattedPrice = new Intl.NumberFormat('fr-FR').format(service.price);
                    const formattedTotal = new Intl.NumberFormat('fr-FR').format(service.total);
                    
                    row.innerHTML = `
                        <td class="ps-3">${service.name}</td>
                        <td class="text-center">${service.quantity}</td>
                        <td class="text-center">${formattedPrice} FCFA</td>
                        <td class="text-end pe-3">${formattedTotal} FCFA</td>
                    `;
                    
                    summaryItems.appendChild(row);
                    subtotal += service.total;
                });
                
                // Calculer les frais de livraison
                const deliveryFeeObj = calculateDeliveryFee();
                const totalPrice = subtotal + deliveryFeeObj.total;
                
                // Mettre à jour les totaux
                document.getElementById('summary-subtotal').textContent = `${new Intl.NumberFormat('fr-FR').format(subtotal)} FCFA`;
                document.getElementById('summary-delivery-fees').textContent = `${new Intl.NumberFormat('fr-FR').format(deliveryFeeObj.total)} FCFA`;
                document.getElementById('summary-total').textContent = `${new Intl.NumberFormat('fr-FR').format(totalPrice)} FCFA`;
            } else {
                summaryItems.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center py-3">Aucun service sélectionné</td>
                    </tr>
                `;
                
                document.getElementById('summary-subtotal').textContent = '0 FCFA';
                document.getElementById('summary-delivery-fees').textContent = '0 FCFA';
                document.getElementById('summary-total').textContent = '0 FCFA';
            }
        }
    }

    function calculateQuotaEquivalent() {
        // Get total price from summary
        const totalPriceElement = document.getElementById('summary-total');
        const quotaEquivalentElement = document.getElementById('quota-equivalent');
        
        if (totalPriceElement && quotaEquivalentElement) {
            const totalPrice = parseFloat(totalPriceElement.textContent.replace(/\s/g, '').replace('FCFA', '')) || 0;
            
            // Assume 1kg = 500 FCFA (This should be replaced with actual conversion from backend)
            const quotaRate = 500;
            
            // Calculate equivalent in kg
            const quotaEquivalent = totalPrice / quotaRate;
            
            // Display equivalent
            quotaEquivalentElement.textContent = `Équivalent en quota: ${quotaEquivalent.toFixed(1)} kg`;
            
            // Check if user has enough quota and enable/disable radio button
            const quotaRadio = document.getElementById('payment-quota');
            const availableQuota = {{ Auth::user()->getTotalAvailableQuota() ?? 0 }};
            
            if (quotaRadio) {
                if (availableQuota < quotaEquivalent) {
                    quotaRadio.disabled = true;
                    quotaRadio.checked = false;
                    document.getElementById('payment-cash').checked = true;
                    quotaEquivalentElement.classList.add('text-danger');
                    quotaEquivalentElement.textContent += ' (quota insuffisant)';
                } else {
                    quotaRadio.disabled = false;
                    quotaEquivalentElement.classList.remove('text-danger');
                }
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // ... existing code ...

        // Gestion des bons de livraison
        const voucherCodeInput = document.getElementById('delivery_voucher_code');
        const applyVoucherBtn = document.getElementById('apply_voucher');
        const useVoucherCheckbox = document.getElementById('use_delivery_voucher');
        const voucherMessage = document.getElementById('delivery_voucher_message');
        const voucherFields = document.getElementById('voucher_fields');

        // Afficher/masquer les champs de bon quand la case est cochée/décochée
        if (useVoucherCheckbox) {
            useVoucherCheckbox.addEventListener('change', function() {
                if (voucherFields) {
                    voucherFields.style.display = this.checked ? 'block' : 'none';
                }
                
                // Réinitialiser le message si on décoche
                if (!this.checked && voucherMessage) {
                    voucherMessage.innerHTML = '';
                }
                
                // Mettre à jour les totaux pour refléter l'utilisation ou non du bon
                updateTotals();
                
                // Mettre à jour également le récapitulatif
                if (currentStep === 4) {
                    updateFullSummary();
                }
            });
        }

        // Vérifier un bon de livraison
        if (applyVoucherBtn) {
            applyVoucherBtn.addEventListener('click', function() {
                const code = voucherCodeInput.value.trim();
                if (!code) {
                    voucherMessage.innerHTML = '<div class="alert alert-danger mt-2"><i class="bi bi-exclamation-triangle-fill me-2"></i>Veuillez saisir un code</div>';
                    return;
                }

                // Créer un élément pour montrer le chargement
                voucherMessage.innerHTML = '<div class="alert alert-info mt-2"><i class="bi bi-hourglass-split me-2"></i>Vérification en cours...</div>';

                // Obtenir le token CSRF
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                // Vérifier la validité du bon via AJAX
                fetch('/api/check-delivery-voucher', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Réponse reçue:', data);
                    if (data.valid) {
                        voucherMessage.innerHTML = '<div class="alert alert-success mt-2"><i class="bi bi-check-circle-fill me-2"></i>' + data.message + '</div>';
                        
                        // Mettre à jour les totaux pour refléter la livraison gratuite
                        updateTotals();
                    } else {
                        voucherMessage.innerHTML = '<div class="alert alert-danger mt-2"><i class="bi bi-exclamation-triangle-fill me-2"></i>' + data.message + '</div>';
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la vérification du bon:', error);
                    voucherMessage.innerHTML = '<div class="alert alert-danger mt-2"><i class="bi bi-exclamation-triangle-fill me-2"></i>Erreur lors de la vérification du bon. Veuillez réessayer.</div>';
                });
            });
        }

        // Modifier la fonction updateTotals pour prendre en compte les bons de livraison
        const originalUpdateTotals = updateTotals;
        updateTotals = function() {
            // Appeler la fonction originale
            if (typeof originalUpdateTotals === 'function') {
                originalUpdateTotals();
            }
            
            // Si un bon de livraison est utilisé, mettre à jour les frais de livraison
            if (useVoucherCheckbox && useVoucherCheckbox.checked) {
                // Récupérer l'élément qui affiche les frais de livraison dans le récapitulatif
                const deliveryFeeDisplay = document.getElementById('summary-delivery-fees');
                if (deliveryFeeDisplay) {
                    // Stocker l'ancien montant pour pouvoir recalculer le total
                    const oldDeliveryFee = parseFloat(deliveryFeeDisplay.textContent.replace(/\s/g, '').replace('FCFA', '')) || 0;
                    deliveryFeeDisplay.textContent = '0 FCFA (Gratuit)';
                    
                    // Récupérer et mettre à jour le total
                    const summaryTotal = document.getElementById('summary-total');
                    const subtotal = parseFloat(document.getElementById('summary-subtotal').textContent.replace(/\s/g, '').replace('FCFA', '')) || 0;
                    if (summaryTotal) {
                        summaryTotal.textContent = new Intl.NumberFormat('fr-FR').format(subtotal) + ' FCFA';
                    }
                    
                    // Mettre à jour aussi l'affichage dans l'étape de paiement
                    const paymentDeliveryFee = document.getElementById('payment-delivery-fee');
                    const paymentTotal = document.getElementById('payment-total');
                    if (paymentDeliveryFee) {
                        paymentDeliveryFee.textContent = '0 FCFA (Gratuit)';
                    }
                    if (paymentTotal) {
                        paymentTotal.textContent = new Intl.NumberFormat('fr-FR').format(subtotal) + ' FCFA';
                    }
                }
            }
        };

        // Vérifier si l'utilisateur a des bons de livraison disponibles
        fetch('/api/available-delivery-vouchers')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.count > 0) {
                    // Créer un message d'alerte
                    const voucherAlert = document.createElement('div');
                    voucherAlert.className = 'alert alert-info alert-dismissible fade show mb-4';
                    voucherAlert.role = 'alert';
                    voucherAlert.innerHTML = `
                        <div class="d-flex">
                            <div class="me-3">
                                <i class="bi bi-ticket-perforated fs-4"></i>
                            </div>
                            <div>
                                <strong>Bon(s) de livraison disponible(s)!</strong>
                                <p class="mb-0">Vous avez ${data.count} bon(s) de livraison disponible(s). N'oubliez pas de l'utiliser pour bénéficier d'une livraison gratuite!</p>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    
                    // Insérer le message au début du formulaire
                    const formElement = document.querySelector('.order-creation-pressing-page');
                    if (formElement) {
                        formElement.prepend(voucherAlert);
                    }
                }
            })
            .catch(error => console.error('Erreur lors de la vérification des bons de livraison:', error));
            
        // ==== GESTION DES CODES PROMO ====
        // Variables pour le stockage des informations sur les codes promo
        let currentCoupon = null;
        let availableCoupons = [];
        
        // Récupérer les codes promo disponibles
        fetch('/api/available-coupons')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.coupons) {
                    availableCoupons = data.coupons;
                    console.log('Codes promo disponibles:', availableCoupons.length);
                }
            })
            .catch(error => console.error('Erreur lors de la récupération des codes promo:', error));
        
        // Gestion des éléments DOM pour les codes promo
        const couponCodeInput = document.getElementById('coupon_code');
        const applyCouponBtn = document.getElementById('apply_coupon');
        const useCouponCheckbox = document.getElementById('use_coupon');
        const couponMessage = document.getElementById('coupon_message');
        const couponFields = document.getElementById('coupon_fields');
        
        // Afficher/masquer les champs de coupon quand la case est cochée/décochée
        if (useCouponCheckbox) {
            useCouponCheckbox.addEventListener('change', function() {
                if (couponFields) {
                    couponFields.style.display = this.checked ? 'block' : 'none';
                }
                
                // Réinitialiser le coupon si on décoche
                if (!this.checked) {
                    currentCoupon = null;
                    if (couponMessage) couponMessage.innerHTML = '';
                }
                
                // Mettre à jour les totaux
                updateTotals();
                
                // Mettre à jour également le récapitulatif
                if (currentStep === 4) {
                    updateFullSummary();
                }
            });
        }
        
        // Appliquer un code promo
        if (applyCouponBtn) {
            applyCouponBtn.addEventListener('click', function() {
                const code = couponCodeInput.value.trim();
                if (!code) {
                    couponMessage.innerHTML = '<div class="alert alert-danger mt-2"><i class="bi bi-exclamation-triangle-fill me-2"></i>Veuillez saisir un code</div>';
                    return;
                }

                // Afficher le chargement
                couponMessage.innerHTML = '<div class="alert alert-info mt-2"><i class="bi bi-hourglass-split me-2"></i>Vérification en cours...</div>';

                // Obtenir le token CSRF
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                // Vérifier la validité du coupon via AJAX
                fetch('/api/check-coupon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-TOKEN': csrfToken,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.valid) {
                        // Coupon valide, stocker les informations
                        currentCoupon = data.coupon;
                        
                        // Mettre à jour les totaux
                        updateTotals();
                    } else {
                        couponMessage.innerHTML = '<div class="alert alert-danger mt-2"><i class="bi bi-exclamation-triangle-fill me-2"></i>' + data.message + '</div>';
                        currentCoupon = null;
                    }
                })
                .catch(error => {
                    console.error('Erreur lors de la vérification du coupon:', error);
                    couponMessage.innerHTML = '<div class="alert alert-danger mt-2"><i class="bi bi-exclamation-triangle-fill me-2"></i>Erreur lors de la vérification du code. Veuillez réessayer.</div>';
                    currentCoupon = null;
                });
            });
        }
        
        // Mettre à jour la fonction updateTotals pour prendre en compte les codes promo
        const originalUpdateTotalsWithVoucher = updateTotals;
        updateTotals = function() {
            // Récupérer les éléments d'affichage
            const subtotalElement = document.getElementById('summary-subtotal');
            const deliveryFeesElement = document.getElementById('summary-delivery-fees');
            const summaryDiscountElement = document.getElementById('summary-discount');
            const summaryDiscountRow = document.getElementById('summary-discount-row');
            const summaryTotalElement = document.getElementById('summary-total');
            const paymentDiscountElement = document.getElementById('payment-discount');
            const paymentDiscountBadge = document.getElementById('payment-discount-badge');
            const paymentTotalElement = document.getElementById('payment-total');
            
            // Appeler d'abord la fonction précédente (qui gère les bons de livraison)
            if (typeof originalUpdateTotalsWithVoucher === 'function') {
                originalUpdateTotalsWithVoucher();
            }
            
            // Si pas d'éléments nécessaires ou pas de coupon actif, sortir
            if (!subtotalElement || !summaryTotalElement || !currentCoupon || !useCouponCheckbox || !useCouponCheckbox.checked) {
                // Masquer la ligne de réduction
                if (summaryDiscountRow) summaryDiscountRow.style.display = 'none';
                if (paymentDiscountBadge) paymentDiscountBadge.style.display = 'none';
                return;
            }
            
            // Récupérer les montants actuels
            const subtotal = parseFloat(subtotalElement.textContent.replace(/\s/g, '').replace('FCFA', '')) || 0;
            let deliveryFee = 0;
            if (deliveryFeesElement) {
                // Extraire seulement le nombre du texte (il peut contenir "Gratuit")
                const deliveryFeeText = deliveryFeesElement.textContent;
                const match = deliveryFeeText.match(/(\d+)/);
                deliveryFee = match ? parseInt(match[0]) : 0;
            }
            const totalBeforeDiscount = subtotal + deliveryFee;
            
            // Vérifier si le montant minimum est atteint
            if (currentCoupon.min_order_amount && totalBeforeDiscount < currentCoupon.min_order_amount) {
                // Montant minimum non atteint
                couponMessage.innerHTML = `<div class="alert alert-warning mt-2">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Montant minimum requis non atteint. 
                    Montant actuel: ${new Intl.NumberFormat('fr-FR').format(totalBeforeDiscount)} FCFA, 
                    minimum requis: ${new Intl.NumberFormat('fr-FR').format(currentCoupon.min_order_amount)} FCFA
                </div>`;
                
                // Masquer la ligne de réduction
                if (summaryDiscountRow) summaryDiscountRow.style.display = 'none';
                if (paymentDiscountBadge) paymentDiscountBadge.style.display = 'none';
                return;
            }
            
            // Calculer la réduction
            let discount = 0;
            if (currentCoupon.type === 'percentage') {
                discount = totalBeforeDiscount * (currentCoupon.value / 100);
                couponMessage.innerHTML = `<div class="alert alert-success mt-2">
                    <i class="bi bi-check-circle-fill me-2"></i>Code valide: Remise de ${currentCoupon.value}% appliquée
                </div>`;
            } else {
                discount = Math.min(currentCoupon.value, totalBeforeDiscount);
                couponMessage.innerHTML = `<div class="alert alert-success mt-2">
                    <i class="bi bi-check-circle-fill me-2"></i>Code valide: Remise de ${new Intl.NumberFormat('fr-FR').format(currentCoupon.value)} FCFA appliquée
                </div>`;
            }
            
            // Appliquer le plafond de remise si défini
            if (currentCoupon.max_discount_amount && discount > currentCoupon.max_discount_amount) {
                discount = currentCoupon.max_discount_amount;
            }
            
            // Mettre à jour les affichages
            const finalTotal = Math.max(0, totalBeforeDiscount - discount);
            
            // Mettre à jour le récapitulatif
            if (summaryDiscountElement) {
                summaryDiscountElement.textContent = `-${new Intl.NumberFormat('fr-FR').format(discount)} FCFA`;
                summaryDiscountRow.style.display = 'table-row';
            }
            if (summaryTotalElement) {
                summaryTotalElement.textContent = `${new Intl.NumberFormat('fr-FR').format(finalTotal)} FCFA`;
            }
            
            // Mettre à jour l'affichage dans l'étape de paiement
            if (paymentDiscountElement) {
                paymentDiscountElement.textContent = `-${new Intl.NumberFormat('fr-FR').format(discount)} FCFA`;
                paymentDiscountBadge.style.display = 'inline-block';
            }
            if (paymentTotalElement) {
                paymentTotalElement.textContent = `${new Intl.NumberFormat('fr-FR').format(finalTotal)} FCFA`;
            }
            
            // Mettre à jour l'équivalent en quota si applicable
            calculateQuotaEquivalent();
        };
    });
</script>
@endpush
</script>
@endpush